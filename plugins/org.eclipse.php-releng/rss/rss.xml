<?xml version="1.0" encoding="UTF-8"?>
<project name="RssUtitlities" default="nodefault">
	<target name="nodefault">
	</target>

	<taskdef name="RssAddProject" classname="rss2ant.RssAddProject" />
	<taskdef name="RssAddCenter" classname="rss2ant.RssAddCenter" />
	<taskdef name="RssSendMessage" classname="rss2ant.RssSendMessage" />
	<taskdef name="RssGenerator" classname="rss2ant.RssGenerator" />


	<tstamp />
	<property name="date" value="${DSTAMP}" />
	<property name="time" value="${TSTAMP}" />
	<tstamp>
	    <format property="bugFormat" pattern="yyyy-M-d" locale="en,UK"/>
	</tstamp>
	<property name="junitreport-html-file" value="../src/results/TEST-php.html" />
	<property name="junitreport-xml-file" value="../src/results/TEST-php.xml" />	
	
	<property name="buildDirectory" location="${basedir}/../src/eclipse" />
	<property file="${buildDirectory}/label.properties"/>
	<property name="remoteDirectory" value="downloads/drops" />

	<property name="timestamp" value="${date} ${time}" />
	<property name="rssProjectName" value="PHP" />
	<property name="rssCenterName" value="blackboard " />
	<property name="rssCenterDescription" value="This is a blackboard center to ${rssProjectName}" />
	<property name="rssCenterAbout" value="" />
	<property name="rssTitle" value="error! set a message here" />
	<property name="rssMessageDescription" value="" />
	<property name="rssMessageContributor" value="PHP Build Server" />
	<property name="rssMessageLink" value="http://download.eclipse.org/tools/pdt/downloads/drops/${buildLabel}/results/TEST-php.html" />
	<property name="rssOutputFile" value="center.xml" />
	<property file="link.properties" />

	<target name="createProject">
		<RssAddProject projectName="${rssProjectName}" />
	</target>

	<target name="createCenter">
		<RssAddCenter projectName="${rssProjectName}" centerName="${rssCenterName}" description="${rssCenterDescription}" about="${rssCenterAbout}" link="http://www.eclipse.org/pdt" />
	</target>

	<target name="addMessage">
		<loadfile property="description" srcFile="content"/>
		<RssSendMessage projectName="${rssProjectName}" centerName="${rssCenterName}" title="${rssTitle}" link="${rssMessageLink}" description="${description}" contibutor="${rssMessageContributor}" />
	</target>

	<target name="addBugsMessage">
		<loadfile property="title" srcFile="summary"/>
		<loadfile property="description" srcFile="bugs"/>
		<RssSendMessage projectName="${rssProjectName}" centerName="${rssCenterName}" title="${title}" link="${bugLink}" description="${description}" contibutor="${rssMessageContributor}" />
	</target>

	<target name="generateRss">
		<RssGenerator projectName="${rssProjectName}" centerName="${rssCenterName}" xmlFilename="${rssOutputFile}" />
	</target>

	<target name="uploadRss">

		<property name="source" value="${rssOutputFile}" />
		<property name="target" value="rss/${rssOutputFile}" />

		<exec dir="." executable="rsync">
			<arg line="-avz --password-file=$HOME/.pass --stats ${source} apeled@dev.eclipse.org:/home/data/httpd/download.eclipse.org/tools/pdt/downloads/${target}" />
		</exec>
	</target>

	<target name="mailUnitTestResults">
		<mail from="php-unit-test-daemon@eclipse.org " encoding="auto" tolist="pdt-unit-test@eclipse.org" files="${junitreport-html-file} bug_distribution.csv" subject="Nightly build results ${timestamp}" />
	</target>
	
	<target name="getTestResults">
		<xslt in="${junitreport-xml-file}" out="content" style="style.xsl">
			<outputproperty name="method" value="text" />
			<outputproperty name="omit-xml-declaration" value="yes" />			
			<outputproperty name="indent" value="no" />
		</xslt>
	</target>

	<target name="pushNightly">
	
		<echo message="RSYNC to: ${remoteDirectory}/${buildLabel}" />
		<!-- Need to get permissions correct so that Webserver will work. -->
		<chmod dir="${buildDirectory}" type="file" perm="ugo+r" includes="${buildLabel}/**" />
		<chmod dir="${buildDirectory}" type="file" perm="ug+rw" includes="${buildLabel}/**" />
		<chmod dir="${buildDirectory}" type="dir" perm="ugo+rx" includes="${buildLabel}*/**" />
		<chmod dir="${buildDirectory}" type="dir" perm="ug+rwx" includes="${buildLabel}*/**" />
		<exec dir="${buildDirectory}" executable="rsync">
			<arg line="-avz --password-file=$HOME/.pass --stats --include *.zip --exclude bldindex.html ${buildLabel} apeled@dev.eclipse.org:~/downloads/tools/pdt/${remoteDirectory}" />
		</exec>

		<property name="source" value="${junitreport-html-file}" />
		<property name="target" value="reports/TEST-php${date}.html" />
		<exec dir="." executable="rsync">
			<arg line="-avz --password-file=$HOME/.pass --stats ${source} apeled@dev.eclipse.org:/home/data/httpd/download.eclipse.org/tools/pdt/${remoteDirectory}/${buildLabel}/results/"/>
		</exec>


	</target>

</project>
